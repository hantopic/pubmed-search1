<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PubMed 검색 결과</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        .download-button {
            margin: 1em 0;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .download-button:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <h1>🔍 "{{ query }}" 검색 결과 (총 {{ results|length }}개)</h1>

    <form method="post" action="/download">
        <input type="hidden" name="csv_data" value="{{ results|tojson }}">
        <button type="submit" class="download-button">📄 CSV 다운로드</button>
    </form>

    <button id="download-pdfs" class="download-button">📥 PDF 일괄 다운로드</button>

    <table>
        <thead>
            <tr>
                <th>제목</th>
                <th>저자</th>
                <th>저널</th>
                <th>연도</th>
                <th>권(호)</th>
                <th>페이지</th>
                <th>PMID</th>
                <th>PDF</th>
                <th>키워드</th>
                <th>요약</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result.title }}</td>
                <td>{{ result.authors }}</td>
                <td>{{ result.journal }}</td>
                <td>{{ result.year }}</td>
                <td>{{ result.volume }}({{ result.issue }})</td>
                <td>{{ result.pages }}</td>
                <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.pmid }}/" target="_blank">{{ result.pmid }}</a></td>
                <td><a href="{{ result.pdf_link }}" class="pdf-link" target="_blank">PDF</a></td>
                <td>{{ result.keywords }}</td>
                <td>{{ result.summary }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    document.getElementById("download-pdfs").addEventListener("click", function () {
        const pdfLinks = Array.from(document.querySelectorAll("a.pdf-link"))
            .map(link => link.href);

        if (pdfLinks.length === 0) {
            alert("다운로드 가능한 PDF 링크가 없습니다.");
            return;
        }

        fetch("/download_pdfs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pdf_urls: pdfLinks })
        })
            .then(response => {
                if (!response.ok) throw new Error("다운로드 실패");
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "papers.zip";
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => alert("오류 발생: " + error.message));
    });
    </script>
</body>
</html>
