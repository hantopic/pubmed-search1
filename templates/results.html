<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PubMed ê²€ìƒ‰ ê²°ê³¼</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        .download-button {
            margin: 1em 0;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .download-button:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <h1>ğŸ” "{{ query }}" ê²€ìƒ‰ ê²°ê³¼ (ì´ {{ results|length }}ê°œ)</h1>

    <form method="post" action="/download">
        <input type="hidden" name="csv_data" value="{{ results|tojson }}">
        <button type="submit" class="download-button">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
    </form>

    <button id="download-pdfs" class="download-button">ğŸ“¥ PDF ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button>

    <table>
        <thead>
            <tr>
                <th>ì œëª©</th>
                <th>ì €ì</th>
                <th>ì €ë„</th>
                <th>ì—°ë„</th>
                <th>ê¶Œ(í˜¸)</th>
                <th>í˜ì´ì§€</th>
                <th>PMID</th>
                <th>PDF</th>
                <th>í‚¤ì›Œë“œ</th>
                <th>ìš”ì•½</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result.title }}</td>
                <td>{{ result.authors }}</td>
                <td>{{ result.journal }}</td>
                <td>{{ result.year }}</td>
                <td>{{ result.volume }}({{ result.issue }})</td>
                <td>{{ result.pages }}</td>
                <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.pmid }}/" target="_blank">{{ result.pmid }}</a></td>
                <td><a href="{{ result.pdf_link }}" class="pdf-link" target="_blank">PDF</a></td>
                <td>{{ result.keywords }}</td>
                <td>{{ result.summary }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    document.getElementById("download-pdfs").addEventListener("click", function () {
        const pdfLinks = Array.from(document.querySelectorAll("a.pdf-link"))
            .map(link => link.href);

        if (pdfLinks.length === 0) {
            alert("ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ PDF ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        fetch("/download_pdfs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pdf_urls: pdfLinks })
        })
            .then(response => {
                if (!response.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "papers.zip";
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message));
    });
    </script>
</body>
</html>
